#!/bin/bash

#get system information
chip=$(arch)
os_ver=$(sw_vers -productVersion)

#newline scroll
printf "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"

#check mac compatibility

if [ $chip = 'arm64' ]; then
	if echo -e "$os_ver \n13.0.0" | sort -V | tail -n1 | grep -Fq "13.0.0"; then
		printf "\033[31;1mYour mac is not compatible. It has to be Ventura or later. Consider updating it. \033[0m\n"
		exit 1
	fi
else 
	if echo -e "$os_ver \n10.12.0" | sort -V | tail -n1 | grep -Fq "10.12.0"; then
		printf "\033[31;1mYour mac is not compatible. It has to be 10.12 or later. Consider updating it. \033[0m\n"
		exit 1
	fi
fi

printf "\033[32;1mYour mac is compatible \033[0m\n\n\n"

#Check if python ver is installed

python_ver="3.9"
python_link="/www.python.org/ftp/python/3.9.5/python-3.9.5-macos11.pkg"
if [ $chip = 'i386' ]; then
	if echo -e "$os_ver \n10.15.0" | sort -V | tail -n1 | grep -Fq "10.15.0"; then
		python_ver="3.7"
		python_link="/www.python.org/ftp/python/3.7.0/python-3.7.0-macosx10.9.pkg"
	elif echo -e "$os_ver \n12.0.0" | sort -V | tail -n1 | grep -Fq "12.0.0"; then
		python_ver="3.8"
		python_link="/www.python.org/ftp/python/3.8.0/python-3.8.0-macosx10.9.pkg"
	else 
		python_link="/www.python.org/ftp/python/3.9.5/python-3.9.5-macosx10.9.pkg"
	fi
fi

filename=$(echo "${python_link}" | sed -e 's/\/.*\///g')
printf "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"
if python"${python_ver}" --version; then
	printf "\033[1;35mPython is already installed\033[0m\n"
else
	printf "\033[1;35mPython is not installed, installing python ${python_ver}\nThere should be a popup for the python installer.\033[0m"
	curl -O "https:/${python_link}" && open "${filename}"
fi

echo "\033[1;35mEnter when python is done installing\033[0m"
read
printf "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"
printf "\033[1;35mInstalling command line tools.\nThere should be a pop-up.\nClick the install button\033[0m\n\n"
xcode-select --install
echo "\033[1;35mEnter when xcode command line tools is done installing\033[0m"
read
echo "Enter your admin password (the password used to log into the admin user)"
sudo xcode-select --switch /Library/Developer/CommandLineTools
printf "\033[1;35mInstalling rust\033[0m"
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
printf "\033[1;35mMaking sure pip is installed\033[0m"
python3 -m ensurepip

echo "Installing libraries"
if [ $chip = 'arm64' ]; then
	python"${python_ver}" -m pip install pyautogui pillow discord-webhook discord.py pynput matplotlib pymupdf
	python"${python_ver}" -m pip install paddlepaddle==2.3.2
	python"${python_ver}" -m pip install --no-deps paddleocr==2.6.1.0
	python"${python_ver}" -m pip install --default-timeout=100 attrdict beautifulsoup4 cython fire fonttools imgaug lanms-neo==1.0.2 lmdb lxml opencv-contrib-python opencv-python==4.5.5.64 openpyxl pdf2docx Polygon3 premailer pyclipper pymupdf==1.23.5 python-docx rapidfuzz scikit-image shapely tqdm visualdl
	python"${python_ver}" -m pip install "numpy<1.24.0"
	python"${python_ver}" -m pip install "pyscreeze<0.1.29"
	pip"${python_ver}" install orjson==3.9.6

elif echo -e "$os_ver \n10.15.0" | sort -V | tail -n1 | grep -Fq "10.15.0"; then
	python"${python_ver}" -m pip install --upgrade pip setuptools wheel
	python"${python_ver}" -m pip install paddlepaddle opencv-python==4.4.0.46 opencv-contrib-python==4.4.0.46 numpy==1.19.1 Polygon3
	python"${python_ver}" -m pip install --no-deps paddleocr==2.6.1.3 scikit-image pdf2docx imgaug visualdl tritonclient 
	python"${python_ver}" -m pip install python-rapidjson==1.10 pywavelets==1.1.1 imageio networkx packaging pillow tifffile scipy attrdict beautifulsoup4 cython fire fonttools lanms-neo==1.0.2 lmdb openpyxl premailer pyclipper python-docx rapidfuzz shapely tqdm greenlet==1.1.2 pyautogui pillow discord-webhook discord.py pynput matplotlib pymupdf bce-python-sdk flask flask-babel gradio onnx pandas psutil rarfile x2paddle lazy_loader
	STATIC_DEPS=true pip3 install lxml 
	python"${python_ver}" -m pip install "numpy<1.24.0"
	python"${python_ver}" -m pip install "pyscreeze<0.1.29"
	pip"${python_ver}" install "urllib3<2"
	pip"${python_ver}" install "protobuf<4"
else
	python"${python_ver}" -m pip install pyautogui pillow discord-webhook discord.py pynput matplotlib pymupdf
	python"${python_ver}" -m pip install paddlepaddle==2.4.2 -i https://pypi.tuna.tsinghua.edu.cn/simple
	python"${python_ver}" -m pip install --no-deps paddleocr==2.6.1.3
	python"${python_ver}" -m pip install --default-timeout=100 attrdict beautifulsoup4 cython fire fonttools imgaug lanms-neo==1.0.2 lmdb lxml opencv-contrib-python==4.6.0.66 opencv-python==4.6.0.66 openpyxl pdf2docx Polygon3 premailer pyclipper pymupdf python-docx rapidfuzz scikit-image shapely tqdm visualdl
	python"${python_ver}" -m pip install "numpy<1.24.0"
	python"${python_ver}" -m pip install "pyscreeze<0.1.29"
	pip"${python_ver}" install protobuf==3.20.0
	pip"${python_ver}" install orjson==3.9.6
fi
printf "\n\n\n\033[32;1mInstallation complete!Visit the discord on instructions for settings and permissions \033[0m\n"
read
